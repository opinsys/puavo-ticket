<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>models/server/Ticket.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Backbone.Collection.html">Backbone.Collection</a></li>
            
                <li><a href="../classes/Backbone.Events.html">Backbone.Events</a></li>
            
                <li><a href="../classes/Backbone.Model.html">Backbone.Model</a></li>
            
                <li><a href="../classes/Bluebird.Promise.html">Bluebird.Promise</a></li>
            
                <li><a href="../classes/Bookshelf.Collection.html">Bookshelf.Collection</a></li>
            
                <li><a href="../classes/Bookshelf.Model.html">Bookshelf.Model</a></li>
            
                <li><a href="../classes/components.AttachmentsForm.html">components.AttachmentsForm</a></li>
            
                <li><a href="../classes/components.CommentForm.html">components.CommentForm</a></li>
            
                <li><a href="../classes/components.EditableText.html">components.EditableText</a></li>
            
                <li><a href="../classes/components.ElasticTextarea.html">components.ElasticTextarea</a></li>
            
                <li><a href="../classes/components.ErrorMessage.html">components.ErrorMessage</a></li>
            
                <li><a href="../classes/components.FileItem.html">components.FileItem</a></li>
            
                <li><a href="../classes/components.ForcedLinebreaks.html">components.ForcedLinebreaks</a></li>
            
                <li><a href="../classes/components.Loading.html">components.Loading</a></li>
            
                <li><a href="../classes/components.Loading.Spinner.html">components.Loading.Spinner</a></li>
            
                <li><a href="../classes/components.Main.html">components.Main</a></li>
            
                <li><a href="../classes/components.NotificationBox.html">components.NotificationBox</a></li>
            
                <li><a href="../classes/components.NotificationsHub.html">components.NotificationsHub</a></li>
            
                <li><a href="../classes/components.NotificationsHub.NotificationItem.html">components.NotificationsHub.NotificationItem</a></li>
            
                <li><a href="../classes/components.OnViewportMixin.html">components.OnViewportMixin</a></li>
            
                <li><a href="../classes/components.ProfileBadge.html">components.ProfileBadge</a></li>
            
                <li><a href="../classes/components.Redacted.html">components.Redacted</a></li>
            
                <li><a href="../classes/components.SelectUsers.html">components.SelectUsers</a></li>
            
                <li><a href="../classes/components.SelectUsers.UserItem.html">components.SelectUsers.UserItem</a></li>
            
                <li><a href="../classes/components.SideInfo.html">components.SideInfo</a></li>
            
                <li><a href="../classes/components.StringDiff.html">components.StringDiff</a></li>
            
                <li><a href="../classes/components.TicketForm.html">components.TicketForm</a></li>
            
                <li><a href="../classes/components.TicketList.html">components.TicketList</a></li>
            
                <li><a href="../classes/components.TicketList.TitleList.html">components.TicketList.TitleList</a></li>
            
                <li><a href="../classes/components.TicketView.html">components.TicketView</a></li>
            
                <li><a href="../classes/components.TicketView.CommentUpdate.html">components.TicketView.CommentUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.HandlerUpdate.html">components.TicketView.HandlerUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.TagUpdate.html">components.TicketView.TagUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.TitleUpdate.html">components.TicketView.TitleUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.ToggleFollowButton.html">components.TicketView.ToggleFollowButton</a></li>
            
                <li><a href="../classes/components.TicketView.ToggleStatusButton.html">components.TicketView.ToggleStatusButton</a></li>
            
                <li><a href="../classes/components.TicketView.UpdateMixin.html">components.TicketView.UpdateMixin</a></li>
            
                <li><a href="../classes/components.TimeAgo.html">components.TimeAgo</a></li>
            
                <li><a href="../classes/components.UploadProgress.html">components.UploadProgress</a></li>
            
                <li><a href="../classes/components.User.html">components.User</a></li>
            
                <li><a href="../classes/models.BaseMixin.html">models.BaseMixin</a></li>
            
                <li><a href="../classes/models.client.Base.html">models.client.Base</a></li>
            
                <li><a href="../classes/models.client.Base.Collection.html">models.client.Base.Collection</a></li>
            
                <li><a href="../classes/models.client.Base.NotFound.html">models.client.Base.NotFound</a></li>
            
                <li><a href="../classes/models.client.Comment.html">models.client.Comment</a></li>
            
                <li><a href="../classes/models.client.Device.html">models.client.Device</a></li>
            
                <li><a href="../classes/models.client.Handler.html">models.client.Handler</a></li>
            
                <li><a href="../classes/models.client.models.UserMixin.html">models.client.models.UserMixin</a></li>
            
                <li><a href="../classes/models.client.Notification.html">models.client.Notification</a></li>
            
                <li><a href="../classes/models.client.Tag.html">models.client.Tag</a></li>
            
                <li><a href="../classes/models.client.Ticket.html">models.client.Ticket</a></li>
            
                <li><a href="../classes/models.client.Ticket.Collection.html">models.client.Ticket.Collection</a></li>
            
                <li><a href="../classes/models.client.TicketView.opinsysRobot.html">models.client.TicketView.opinsysRobot</a></li>
            
                <li><a href="../classes/models.client.Title.html">models.client.Title</a></li>
            
                <li><a href="../classes/models.client.UpdatesCollection.html">models.client.UpdatesCollection</a></li>
            
                <li><a href="../classes/models.server.Attachment.html">models.server.Attachment</a></li>
            
                <li><a href="../classes/models.server.Base.html">models.server.Base</a></li>
            
                <li><a href="../classes/models.server.Chunk.html">models.server.Chunk</a></li>
            
                <li><a href="../classes/models.server.Comment.html">models.server.Comment</a></li>
            
                <li><a href="../classes/models.server.Device.html">models.server.Device</a></li>
            
                <li><a href="../classes/models.server.Email.html">models.server.Email</a></li>
            
                <li><a href="../classes/models.server.Follower.html">models.server.Follower</a></li>
            
                <li><a href="../classes/models.server.Handler.html">models.server.Handler</a></li>
            
                <li><a href="../classes/models.server.Notification.html">models.server.Notification</a></li>
            
                <li><a href="../classes/models.server.Tag.html">models.server.Tag</a></li>
            
                <li><a href="../classes/models.server.Ticket.html">models.server.Ticket</a></li>
            
                <li><a href="../classes/models.server.Ticket.queries.html">models.server.Ticket.queries</a></li>
            
                <li><a href="../classes/models.server.Title.html">models.server.Title</a></li>
            
                <li><a href="../classes/models.server.User.html">models.server.User</a></li>
            
                <li><a href="../classes/models.TagMixin.html">models.TagMixin</a></li>
            
                <li><a href="../classes/models.TicketMixin.html">models.TicketMixin</a></li>
            
                <li><a href="../classes/models.UserInformation.html">models.UserInformation</a></li>
            
                <li><a href="../classes/React.ReactComponent.html">React.ReactComponent</a></li>
            
                <li><a href="../classes/ReactComponent.html">ReactComponent</a></li>
            
                <li><a href="../classes/ReactCompositeComponent.html">ReactCompositeComponent</a></li>
            
                <li><a href="../classes/ReactMountReady.html">ReactMountReady</a></li>
            
                <li><a href="../classes/ReactMultiChild.html">ReactMultiChild</a></li>
            
                <li><a href="../classes/ReactOwner.html">ReactOwner</a></li>
            
                <li><a href="../classes/ReactPropTransferer.html">ReactPropTransferer</a></li>
            
                <li><a href="../classes/ReactReconcileTransaction.html">ReactReconcileTransaction</a></li>
            
                <li><a href="../classes/ReactServerRenderingTransaction.html">ReactServerRenderingTransaction</a></li>
            
                <li><a href="../classes/ReactTestUtils.html">ReactTestUtils</a></li>
            
                <li><a href="../classes/ReactTextComponent.html">ReactTextComponent</a></li>
            
                <li><a href="../classes/server.Request.html">server.Request</a></li>
            
                <li><a href="../classes/server.Response.html">server.Response</a></li>
            
                <li><a href="../classes/test.helpers.html">test.helpers</a></li>
            
                <li><a href="../classes/utils.BrowserTitle.html">utils.BrowserTitle</a></li>
            
                <li><a href="../classes/utils.GridSQL.html">utils.GridSQL</a></li>
            
                <li><a href="../classes/utils.middleware.createResponseLogger.html">utils.middleware.createResponseLogger</a></li>
            
                <li><a href="../classes/utils.middleware.createSlowInternet.html">utils.middleware.createSlowInternet</a></li>
            
                <li><a href="../classes/utils.Puavo.html">utils.Puavo</a></li>
            
                <li><a href="../classes/utils.Superagent.html">utils.Superagent</a></li>
            
                <li><a href="../classes/utils.Transaction.html">utils.Transaction</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/filesize.html">filesize</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected" checked>
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private" checked>
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated" checked>
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: models/server/Ticket.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;
var fs = require(&quot;fs&quot;);
var _ = require(&quot;lodash&quot;);
var Promise = require(&quot;bluebird&quot;);
var crypto = require(&quot;crypto&quot;);

var config = require(&quot;app/config&quot;);
var Base = require(&quot;./Base&quot;);
var Comment = require(&quot;./Comment&quot;);
var Tag = require(&quot;./Tag&quot;);
var RelatedUser = require(&quot;./RelatedUser&quot;);
var Visibility = require(&quot;./Visibility&quot;);
var Follower = require(&quot;./Follower&quot;);
var Handler = require(&quot;./Handler&quot;);
var Device = require(&quot;./Device&quot;);
var User = require(&quot;./User&quot;);
var Notification = require(&quot;./Notification&quot;);
var Title = require(&quot;./Title&quot;);

var debugEmail = require(&quot;debug&quot;)(&quot;app:email&quot;);


/**
 * Knex query helpers
 *
 * @namespace models.server
 * @private
 * @class Ticket.queries
 */
var queries = {

    /**
     * Get updates that are not soft deleted
     *
     * Example:
     *
     *      ticket.tags().query(queries.notSoftDeleted).fetch();
     *
     * @method notSoftDeleted
     */
    notSoftDeleted: function(qb) {
        qb.where(&quot;deleted&quot;, &quot;=&quot;,  &quot;0&quot;);
    },

    softDeleted: function(qb) {
        qb.where(&quot;deleted&quot;, &quot;!=&quot;,  &quot;0&quot;);
    }


};



/**
 * Server Ticket model
 *
 * @namespace models.server
 * @extends models.server.Base
 * @class Ticket
 */
var Ticket = Base.extend({
    tableName: &quot;tickets&quot;,

    defaults: function() {
        return {
            createdAt: new Date(),
            updatedAt: new Date(),
            emailSecret: Ticket.generateSecret()
        };
    },

    /**
     * nodemailer email transport object
     *
     * https://github.com/andris9/Nodemailer
     *
     * @private
     * @property _mailTransport
     * @type Object
     */
    _mailTransport: config.mailTransport,

    /**
     *
     * @method initialize
     * @param attrs Model attributes
     * @param [options.mailTransport] custom mail transport
     */
    initialize: function(attrs, options) {
        var self = this;
        // tests can override the mail transport
        if (options &amp;&amp; options.mailTransport) {
            this._mailTransport = options.mailTransport;
        }

        /**
         * See nodemailer module docs
         * https://github.com/andris9/Nodemailer#sending-mail
         *
         * @method sendMail
         * @param {Object} options
         * @return {Bluebird.Promise}
         * */
        this.sendMail = function(options) {
            return new Promise(function(resolve, reject){
                self._mailTransport.sendMail(options, function(err, res) {
                    if (err) return reject(err);
                    resolve(res);
                });
            });
        };

        this.on(&quot;created&quot;, this._setInitialTicketState.bind(this));
        this.on(&quot;update&quot;, this.onTicketUpdate.bind(this));

    },

    _setInitialTicketState: function (ticket) {
        return ticket.createdBy().fetch().then(function(user) {
            return Promise.join(
                ticket.setStatus(&quot;open&quot;, user, { force: true }),
                ticket.addHandler(user, user),
                ticket.addVisibility(user.getOrganisationAdminVisibility(), user)
            );
        });
    },

    /**
     *
     * @method comments
     * @return {Bookshelf.Collection} Bookshelf.Collection of Ticket comment models
     */
    comments: function() {
        return this.hasMany(Comment, &quot;ticketId&quot;);
    },

    /**
     * Get unread comments for given user. Use &#x60;options.byEmail&#x60; to get those
     * comments that have not been sent out as email.
     *
     * @method unreadComments
     * @param {models.server.User|Number} user or user id
     * @param {options} [options]
     * @param {options} [options.byEmail] get comments that are not emailed
     * @return {Bookshelf.Collection}
     */
    unreadComments: function(user, options){
        var attr = &quot;readAt&quot;;
        if (options &amp;&amp; options.byEmail) {
            attr = &quot;emailSentAt&quot;;
        }

        return this.comments().query(function(q) {
            q.join(&quot;notifications&quot;, function() {
                this.on(&quot;notifications.ticketId&quot;, &quot;=&quot;, &quot;comments.ticketId&quot;);
                this.on(&quot;notifications.&quot; + attr, &quot;&lt;&quot;, &quot;comments.createdAt&quot;);
            });
            q.where({ &quot;notifications.targetId&quot;: Base.toId(user) });
        });
    },

    /**
     *
     * @method titles
     * @return {Bookshelf.Collection} Bookshelf.Collection of Ticket title models
     */
    titles: function() {
        return this.hasMany(Title, &quot;ticketId&quot;);
    },

    /**
     * @method visibilities
     * @return {models.server.Visibility}
     */
    visibilities: function() {
        return this.hasMany(Visibility, &quot;ticketId&quot;);
    },

    notifications: function() {
        return this.hasMany(Notification, &quot;ticketId&quot;);
    },

    /**
     * Add visibility to the ticket. If the visibility already exists for the
     * ticket the existing visibility is returned.
     *
     * Visibility strings can be accessed for example from User#getVisibilities()
     *
     * @method addVisibility
     * @param {String} visibility Visibility string
     * @param {models.server.User|Number} addedBy User model or id of user who adds the visibility
     * @param {String} [comment] Optional comment for the visibility
     * @return {Bluebird.Promise} with models.server.Visibility
     */
    addVisibility: function(visibility, addedBy, comment) {
        var self = this;
        if (typeof visibility !== &quot;string&quot; || !visibility) {
            throw new Error(&quot;visibility must be a non empty string&quot;);
        }

        return Visibility.forge({
                ticketId: self.get(&quot;id&quot;),
                entity: visibility,
            }).fetch()
            .then(function(existingVisibility) {
                if (existingVisibility) return existingVisibility;
                return Visibility.forge({
                    ticketId: self.get(&quot;id&quot;),
                    entity: visibility,
                    comment: comment,
                    createdById: Base.toId(addedBy)
                }).save();
            });
    },

    /**
     * @method triggerUpdate
     * @param {models.server.Base} model Any ticket relation model
     * @return {Bluebird.Promise}
     */
    triggerUpdate: function(model) {
        return this.triggerThen(&quot;update&quot;, {
            model: model
        }).return(model);
    },


    /**
     * Add comment to the ticket
     *
     * @method addComment
     * @param {String} comment
     * @param {models.server.User|Number} user Creator of the tag
     * @param {Boolean} [opts]
     * @param {Boolean} [opts.silent=false] Set to true to disable update notifications
     * @return {Bluebird.Promise} with models.server.Comment
     */
    addComment: function(comment, user, opts) {
        var self = this;
        return Promise.join(
            Comment.forge({
                ticketId: self.get(&quot;id&quot;),
                comment: comment,
                createdById: Base.toId(user)
            }).save(),
            self.addFollower(user, user)
        ).then(function(comment) {
            return self.markAsRead(user).return(comment);
        })
        .spread(function(comment) {
            if (opts &amp;&amp; opts.silent === false) return comment;
            return self.triggerUpdate(comment);
        });
    },

    /**
     * Add title to the ticket
     *
     * @method addTitle
     * @param {String} title
     * @param {models.server.User|Number} user Creator of the tag
     * @param {Boolean} [opts]
     * @param {Boolean} [opts.silent=false] Set to true to disable update notifications
     * @return {Bluebird.Promise} with models.server.Title
     */
    addTitle: function(title, user, opts) {
        return Title.forge({
            ticketId: this.get(&quot;id&quot;),
            title: title,
            createdById: Base.toId(user)
        })
        .save()
        .bind(this)
        .then(function(title) {
            if (opts &amp;&amp; opts.silent === false) return title;
            return this.triggerUpdate(title);
        });
    },

    /**
     * Add Tag to the ticket
     *
     * @method addTag
     * @param {String} tag
     * @param {models.server.User} user Creator of the tag
     * @return {Bluebird.Promise} with models.server.Tag
     */
    addTag: function(tag, user, options) {
        return Tag.forge({
            tag: tag,
            createdById: Base.toId(user),
            ticketId: this.get(&quot;id&quot;)
        }, options).save();
    },

    /**
     * Soft delete given tag
     *
     * @method removeTag
     * @param {String} tag
     * @param {models.server.User|Number} removedBy
     * @param {Object} [options]
     * @param {Boolean} [options.require=false] When true the promise is
     * rejected if the tag is missing
     * @return {Bluebird.Promise}
     */
    removeTag: function(tag, removedBy, options){
        var self = this;
        return Tag.collection()
            .query(queries.notSoftDeleted)
            .query(function(qb) {
                qb.where({
                    tag: tag,
                    ticketId: self.get(&quot;id&quot;),
                });
            })
            .fetch()
            .then(function(tags) {
                if (options &amp;&amp; options.require &amp;&amp; tags.size() === 0) {
                    throw new Error(&quot;Cannot find tag &#x27;&quot; + tag + &quot;&#x27;&quot;);
                }
                return tags.invokeThen(&quot;softDelete&quot;, removedBy);
            });
    },

    /**
     * Get all tags for this ticket
     *
     * @method tags
     * @return {Bookshelf.Collection} Bookshelf.Collection of tag models
     */
    tags: function(){
        return this.hasMany(Tag, &quot;ticketId&quot;);
    },

    /**
     * Set status of the ticket
     *
     * @method setStatus
     * @param {String} status
     * @param {models.server.User} user Creator of the status
     * @param {Boolean} [options.force=false] Set to true to skip manager validation
     * @return {Bluebird.Promise} models.server.Tag representing the status
     */
    setStatus: function(status, user, options){
        return this.addTag(&quot;status:&quot; + status, user, options);
    },

    /**
     * Return collection containing only one models.server.Tag representing the
     * status of the ticket. When serialized as JSON this field will appear as
     * a simple string field. Example: &#x60;status: &quot;open&quot;&#x60;.
     *
     * @method status
     * @return {Bookshelf.Collection}
     */
    status: function() {
        return this.tags()
            .query(queries.notSoftDeleted)
            .query(function(qb) {
                qb.where(&quot;tag&quot;, &quot;LIKE&quot;, &quot;status:%&quot;);
            });
    },


    /**
     * Add follower to a ticket. Also adds a visibility for the follower.
     *
     * @method addFollower
     * @param {models.server.User|Number} follower User model or id of the follower
     * @param {models.server.User|Number} addedBy User model or id of the user who adds the handler
     * @return {Bluebird.Promise} with models.server.Handler
     */
    addFollower: function(follower, addedBy) {
        var self = this;

        var followerOp = Follower.forge({
            ticketId: self.get(&quot;id&quot;),
            followedById: Base.toId(follower)
        })
        .query(queries.notSoftDeleted)
        .fetch()
        .then(function(followerRelation) {
            if (followerRelation) return followerRelation;
            return Follower.forge({
                ticketId: self.get(&quot;id&quot;),
                followedById: Base.toId(follower),
                createdById: Base.toId(addedBy)
            }).save();
        });


        return Promise.join(
            followerOp,
            self.addVisibility(follower.getPersonalVisibility(), addedBy),
            self.ensureNotification(follower)
        ).spread(function(followerRelation) {
            return followerRelation;
        });

    },

    /**
     * Ensure notification relation for a user
     *
     * @method ensureNotification
     * @param {models.server.User|Number} user
     * @return {Bluebird.Promise} with models.server.Notification
     */
    ensureNotification: function(user) {
        var self = this;

        return Notification.forge({
            ticketId: this.get(&quot;id&quot;),
            targetId: Base.toId(user)
        })
        .fetch()
        .then(function(notification) {
            if (notification) return notification;

            // if relation does not exists create one with zero date i.e. the
            // user has never read the ticket. This makes this ticket visible
            // in notifications api.
            return Notification.forge({
                ticketId: self.get(&quot;id&quot;),
                targetId: Base.toId(user),
                readAt: new Date(0),
                emailSentAt: new Date(0),
            }).save();
        });
    },

    /**
     * Add handler to a ticket
     *
     * @method addHandler
     * @param {models.server.User|Number} handler User model or id of the handler
     * @param {models.server.User|Number} addedBy User model or id of the user who adds the handler
     * @return {Bluebird.Promise} with models.server.Handler
     */
    addHandler: function(handler, addedBy) {
        var self = this;

        if (Base.isModel(handler)) handler = Promise.cast(handler);
        else handler = User.byId(handler).fetch({ require: true });

        return handler.then(function(handler) {
            return Promise.join(

                Handler.fetchOrCreate({
                    ticketId: self.get(&quot;id&quot;),
                    handler: Base.toId(handler)
                })
                .then(function(h) {
                    if (h.isNew()) {
                        h.set({
                            createdById: Base.toId(addedBy),
                        });
                        return h.save();
                    }
                }),

                self.addFollower(handler, addedBy)
            );
        })
        .spread(function(handler) {
            return handler;
        });

    },

    /**
     *
     * @method handlers
     * @return {Bookshelf.Collection} Bookshelf.Collection of Ticket handlers
     */
    handlers: function() {
        return this.hasMany(Handler, &quot;ticketId&quot;);
    },

    /**
     * @method followers
     * @return {Bookshelf.Collection} Bookshelf.Collection of Ticket followers relations
     */
    followers: function(){
        return this.hasMany(Follower, &quot;ticketId&quot;).query(queries.notSoftDeleted);
    },

    /**
     * Remove user from followers
     *
     * @method removeFollower
     * @param {models.server.User} user
     * @param {models.server.User} removedBy
     * @return {Bluebird.Promise}
     *
     */
    removeFollower: function(user, removedBy){
        return this.followers()
            .query(function(qb) {
                qb.where(&quot;followedById&quot;, &quot;=&quot;, user.get(&quot;id&quot;));
            })
            .fetch()
            .then(function(coll) {
                return coll.models;
            })
            .map(function(followerRelation) {
                return followerRelation.softDelete(removedBy);
            });
    },

    handlerUsers: function() {
        return this.belongsToMany(User, &quot;handlers&quot;, &quot;ticketId&quot;, &quot;handler&quot;);
    },

    /**
     * Returns true if the user is handler for this ticket
     *
     * &#x27;handlerUsers&#x27; relation must be loaded with &#x27;withRelated&#x27; in fetch or
     * with Ticket#load(&quot;handlerUsers&quot;)
     *
     * @method isHandler
     * @param {models.server.User|Number}
     * @return {Boolean}
     */
    isHandler: function(user){
        if (!this.relations.handlerUsers) {
            throw new Error(&quot;&#x27;handlerUsers&#x27; relation not loaded&quot;);
        }

        return this.relations.handlerUsers.some(function(handlerUser) {
            return handlerUser.get(&quot;id&quot;) === Base.toId(user);
        });
    },

    /**
     * Get description ie. the first comment
     *
     * @method getDescription
     * @return {String}
     */
    getDescription: function() {
        if (!this.relations.comments) {
            throw new Error(&quot;&#x27;comments&#x27; relation not loaded&quot;);
        }

        if (this.relations.comments.length === 0) {
            throw new Error(&quot;No comments - no description!&quot;);
        }

        return _.min(this.relations.comments.models,  function(m) {
            return m.createdAt().getTime();
        }).get(&quot;comment&quot;);
    },

    /**
     * Add device relation
     *
     * @method addDevice
     * @param {models.server.Device|Number} device Device model or external id of the device
     * @param {models.server.User|Number} addedBy User model or id of user who adds the device
     * @return {Bluebird.Promise} with models.server.Device
     */
    addDevice: function(device, addedBy){
        return Device.forge({
                ticketId: this.get(&quot;id&quot;),
                createdById: Base.toId(addedBy),
                hostname: Base.toAttr(device, &quot;hostname&quot;)
            })
            .save();
    },

    /**
     *
     * @method devices
     * @return {Bookshelf.Collection} Bookshelf.Collection of Ticket devices
     */
    devices: function() {
        return this.hasMany(Device, &quot;ticketId&quot;);
    },

    /**
     * Add related user to the ticket
     *
     * @method addRelatedUser
     * @param {models.server.User|Number} user User object or id for the relation
     * @param {models.server.User|Number} addedBy User model or id of user who adds the user
     * @return {Bluebird.Promise} with models.server.RelatedUser
     */
    addRelatedUser: function(user, addedBy){
        return RelatedUser.forge({
            ticketId: this.get(&quot;id&quot;),
            createdById: Base.toId(addedBy),
            user: Base.toId(user)
        }).save();
    },

    /**
     *
     * @method relatedUsers
     * @return {Bookshelf.Collection} Bookshelf.Collection of Ticket related users
     */
    relatedUsers: function() {
        return this.hasMany(RelatedUser, &quot;ticketId&quot;);
    },

    createdBy: function() {
        return this.belongsTo(User, &quot;createdById&quot;);
    },

    /**
     * Mark ticket as read
     *
     * @method markAsRead
     * @param {models.server.User|Number} user User model or id of the user
     * @param {Object} [options]
     * @param {Object} [options.emailOnly] Set to true to mark as read from email
     * @return {Bluebird.Promise} with models.server.Notification
     */
    markAsRead: function(user, options) {
        var self = this;
        return Notification.fetchOrCreate({
            ticketId: self.get(&quot;id&quot;),
            targetId: Base.toId(user)
        })
        .then(function(notification) {
            var now = new Date();

            notification.set({ emailSentAt: now });

            if (!options || !options.emailOnly) {
                notification.set({ readAt: now });
            }

            return notification.save();
        });
    },


    /**
     * Return the current title. Requires &#x60;titles&#x60; relation
     *
     * @method getCurrentTitle
     * @return {String}
     */
    getCurrentTitle: function() {
        if (!this.relations.titles) {
            throw new Error(&quot;titles relation not fetched. Use load or withRelated&quot;);
        }

        var titles = this.relations.titles.models;
        if (titles.length === 0) {
            throw new Error(&quot;Invalid Ticket model. No title!&quot;);
        }

        return _.max(titles, function(m) {
            return m.createdAt().getTime();
        }).get(&quot;title&quot;);
    },

    /**
     * @method getReplyEmailAddress
     * @return {String}
     */
    getReplyEmailAddress: function() {
        return [
            &quot;tukipyynto&quot;, this.get(&quot;id&quot;),
            &quot;+&quot;, this.get(&quot;emailSecret&quot;),
            &quot;@&quot;, config.emailReplyDomain
        ].join(&quot;&quot;);
    },

    /**
     * @method sendBufferedEmailNotifications
     * @param {models.server.User|Number} user User model or id of the user
     * @return {Bluebird.Promise}
     */
    sendBufferedEmailNotifications: function(user){
        var self = this;
        var id = this.get(&quot;id&quot;);
        var email = user.getEmail();
        var title = this.getCurrentTitle();
        var url = &quot;https://support.opinsys.fi/tickets/&quot; + id;
        var subject = &quot;Tukipyyntö \&quot;&quot; + title + &quot;\&quot; (&quot; + id + &quot;) on päivittynyt&quot;;

        return this.unreadComments(user, { byEmail: true }).fetch({
            withRelated: [&quot;createdBy&quot;]
        })
        .then(function(coll) {

            var lastComment = coll.max(function(comment) {
                return comment.createdAt();
            });

            var age = Date.now() - lastComment.createdAt().getTime();

            if (age &lt; 1000 * 60 * 5) {
                debugEmail(
                    &quot;Ticket %s has comments added within last 5min. Skipping email send for %s&quot;,
                    id, user.getDomainUsername()
                );
                return;
            }

            var comments = coll.map(function(comment) {
                return comment.toPlainText();
            }).join(&quot;\n----------------------------------------------\n&quot;);

            debugEmail(
                &quot;Sending notification email about ticket %s for %s (%s)&quot;,
                id, user.getDomainUsername(), user.getEmail()
            );

            var from = &quot;Opinsys tukipalvelu &lt;&quot;+ self.getReplyEmailAddress() +&quot;&gt;&quot;;
            return self.sendMail({
                from: from,
                replyTo: from,
                to: email,
                subject: subject,
                text: renderEmailBufferedTemplate({
                    comments: comments,
                    url: url
                })
            })
            .then(function() {
                return self.markAsRead(user, { emailOnly: true });
            });
        });

    },

    /**
     * Update &#x60;updatedAt&#x60; column to current time. Should be called when ever a
     * update relation is added to the ticket
     *
     * @method updateTimestamp
     * @return {Bluebird.Promise}
     */
    updateTimestamp: function() {
        return this.set(&quot;updatedAt&quot;, new Date()).save();
    },

    onTicketUpdate: function(e){
        return this.updateTimestamp();
    },

    /**
     * @method getSocketIORoom
     * @return {String}
     */
    getSocketIORoom: function() {
        return &quot;ticket:&quot; + this.get(&quot;id&quot;);
    }

}, {

    /**
     * Generate secure random secret for email replies
     *
     * @method generateSecret
     * @return {String}
     */
    generateSecret: function() {
        return crypto.randomBytes(10).toString(&quot;hex&quot;);
    },


    /**
     * Shortcut for creating ticket with a title and description.
     *
     * @method create
     * @param {String} title
     * @param {String} description
     * @param {models.server.User|Number} createdBy
     * @param {Object} [options]
     * @param [options.mailTransport] custom mail transport
     * @return {Bluebird.Promise} with models.server.Ticket
     */
    create: function(title, description, createdBy, opts) {
        return this.forge({ createdById: Base.toId(createdBy) }, opts)
            .save()
            .then(function(ticket) {
                return Promise.join(
                    ticket.addTitle(title, createdBy),
                    ticket.addComment(description, createdBy)
                ).return(ticket);
            })
            .then(function(ticket) {
                return ticket.load([&quot;comments&quot;, &quot;comments.createdBy&quot;]);
            });
    },

    /**
     * Fetch tickets by given visibilities.
     *
     * @static
     * @method byVisibilities
     * @param {Array} visibilities Array of visibility strings. Strings are in the
     * form of &#x60;organisation|school|user:&lt;entity id&gt;&#x60;.
     *
     *     Example: &quot;school:2&quot;
     *
     * @return {models.server.Base.Collection} with models.server.Ticket models
     */
    byVisibilities: function(visibilities) {
        return this.collection()
            .query(function(queryBuilder) {
                queryBuilder
                .join(&quot;visibilities&quot;, &quot;tickets.id&quot;, &quot;=&quot;, &quot;visibilities.ticketId&quot;)
                .whereIn(&quot;visibilities.entity&quot;, visibilities)
                .whereNull(&quot;visibilities.deletedAt&quot;);
            });
    },


    /**
     * Query tickets with visibilities of the user
     *
     * @static
     * @method
     * @param {models.server.User} user
     */
    byUserVisibilities: function(user) {
        // Manager is not restricted by visibilities. Just return everything.
        if (user.isManager()) return this.collection();
        else return this.byVisibilities(user.getVisibilities());
    },

    /**
     * Fetch the ticket by id with visibilities of the user
     *
     * @static
     * @method fetchByIdConstrained
     * @param {models.server.User} user
     * @param {Number} ticketId Ticket id
     * @param {Object} options Options passed to Bookshelf fetchOne method
     * @return {Bluebird.Promise} With models.server.Ticket
     */
    fetchByIdConstrained: function(user, ticketId, opts) {
        return this.byUserVisibilities(user).query({
            where: { &quot;tickets.id&quot;: Base.toId(ticketId) }
        }).fetchOne(_.extend({ require: true }, opts));
    },

    /**
     * Return collection of tickets that have unread comments by the user
     *
     * @static
     * @method withUnreadComments
     * @param {models.client.User|Number} user
     * @param {Object} [options]
     * @param {Object} [options.byEmail=false] Get tickets by unsent email notifications
     * @return {Bookshelf.Collection} of models.server.Ticket
     */
    withUnreadComments: function(user, options) {
        var attr = &quot;readAt&quot;;
        if (options &amp;&amp; options.byEmail) {
            attr = &quot;emailSentAt&quot;;
        }

        return this.byUserVisibilities(user)
            .query(function(qb) {
                qb
                .distinct()
                .join(&quot;followers&quot;, function() {
                    this.on(&quot;tickets.id&quot;, &quot;=&quot;, &quot;followers.ticketId&quot;);
                })
                .join(&quot;notifications&quot;, function() {
                    this.on(&quot;tickets.id&quot;, &quot;=&quot;, &quot;notifications.ticketId&quot;);
                })
                .join(&quot;comments&quot;, function() {
                    this.on(&quot;tickets.id&quot;, &quot;=&quot;, &quot;comments.ticketId&quot;);
                    this.on(&quot;notifications.&quot; + attr, &quot;&lt;&quot;, &quot;comments.createdAt&quot;);
                })
                .whereNull(&quot;followers.deletedAt&quot;)
                .where({
                    &quot;followers.deleted&quot;: 0,
                    &quot;followers.followedById&quot;: Base.toId(user),
                    &quot;notifications.targetId&quot;: Base.toId(user),
                });
            });
    },
});


/**
 * Render buffered email update
 *
 * @private
 * @static
 * @method renderEmailBufferedTemplate
 * @param {Object} context
 * @return {String}
 */
var renderEmailBufferedTemplate = _.template(
    fs.readFileSync(__dirname + &quot;/email_buffered_template.txt&quot;).toString()
);



module.exports = Ticket;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
