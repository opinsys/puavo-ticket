<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>components/Main.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Backbone.Collection.html">Backbone.Collection</a></li>
            
                <li><a href="../classes/Backbone.Events.html">Backbone.Events</a></li>
            
                <li><a href="../classes/Backbone.Model.html">Backbone.Model</a></li>
            
                <li><a href="../classes/Bluebird.Promise.html">Bluebird.Promise</a></li>
            
                <li><a href="../classes/Bookshelf.Collection.html">Bookshelf.Collection</a></li>
            
                <li><a href="../classes/Bookshelf.Model.html">Bookshelf.Model</a></li>
            
                <li><a href="../classes/components.AttachmentsForm.html">components.AttachmentsForm</a></li>
            
                <li><a href="../classes/components.CommentForm.html">components.CommentForm</a></li>
            
                <li><a href="../classes/components.EditableText.html">components.EditableText</a></li>
            
                <li><a href="../classes/components.ElasticTextarea.html">components.ElasticTextarea</a></li>
            
                <li><a href="../classes/components.ErrorMessage.html">components.ErrorMessage</a></li>
            
                <li><a href="../classes/components.FileItem.html">components.FileItem</a></li>
            
                <li><a href="../classes/components.ForcedLinebreaks.html">components.ForcedLinebreaks</a></li>
            
                <li><a href="../classes/components.Loading.html">components.Loading</a></li>
            
                <li><a href="../classes/components.Loading.Spinner.html">components.Loading.Spinner</a></li>
            
                <li><a href="../classes/components.Main.html">components.Main</a></li>
            
                <li><a href="../classes/components.NotificationBox.html">components.NotificationBox</a></li>
            
                <li><a href="../classes/components.NotificationsHub.html">components.NotificationsHub</a></li>
            
                <li><a href="../classes/components.NotificationsHub.NotificationItem.html">components.NotificationsHub.NotificationItem</a></li>
            
                <li><a href="../classes/components.OnViewportMixin.html">components.OnViewportMixin</a></li>
            
                <li><a href="../classes/components.ProfileBadge.html">components.ProfileBadge</a></li>
            
                <li><a href="../classes/components.Redacted.html">components.Redacted</a></li>
            
                <li><a href="../classes/components.SelectUsers.html">components.SelectUsers</a></li>
            
                <li><a href="../classes/components.SelectUsers.UserItem.html">components.SelectUsers.UserItem</a></li>
            
                <li><a href="../classes/components.SideInfo.html">components.SideInfo</a></li>
            
                <li><a href="../classes/components.StringDiff.html">components.StringDiff</a></li>
            
                <li><a href="../classes/components.TicketForm.html">components.TicketForm</a></li>
            
                <li><a href="../classes/components.TicketList.html">components.TicketList</a></li>
            
                <li><a href="../classes/components.TicketList.TitleList.html">components.TicketList.TitleList</a></li>
            
                <li><a href="../classes/components.TicketView.html">components.TicketView</a></li>
            
                <li><a href="../classes/components.TicketView.CommentUpdate.html">components.TicketView.CommentUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.HandlerUpdate.html">components.TicketView.HandlerUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.TagUpdate.html">components.TicketView.TagUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.TitleUpdate.html">components.TicketView.TitleUpdate</a></li>
            
                <li><a href="../classes/components.TicketView.ToggleFollowButton.html">components.TicketView.ToggleFollowButton</a></li>
            
                <li><a href="../classes/components.TicketView.ToggleStatusButton.html">components.TicketView.ToggleStatusButton</a></li>
            
                <li><a href="../classes/components.TicketView.UpdateMixin.html">components.TicketView.UpdateMixin</a></li>
            
                <li><a href="../classes/components.TimeAgo.html">components.TimeAgo</a></li>
            
                <li><a href="../classes/components.UploadProgress.html">components.UploadProgress</a></li>
            
                <li><a href="../classes/components.User.html">components.User</a></li>
            
                <li><a href="../classes/models.BaseMixin.html">models.BaseMixin</a></li>
            
                <li><a href="../classes/models.client.Base.html">models.client.Base</a></li>
            
                <li><a href="../classes/models.client.Base.Collection.html">models.client.Base.Collection</a></li>
            
                <li><a href="../classes/models.client.Base.NotFound.html">models.client.Base.NotFound</a></li>
            
                <li><a href="../classes/models.client.Comment.html">models.client.Comment</a></li>
            
                <li><a href="../classes/models.client.Device.html">models.client.Device</a></li>
            
                <li><a href="../classes/models.client.Handler.html">models.client.Handler</a></li>
            
                <li><a href="../classes/models.client.models.UserMixin.html">models.client.models.UserMixin</a></li>
            
                <li><a href="../classes/models.client.Notification.html">models.client.Notification</a></li>
            
                <li><a href="../classes/models.client.Tag.html">models.client.Tag</a></li>
            
                <li><a href="../classes/models.client.Ticket.html">models.client.Ticket</a></li>
            
                <li><a href="../classes/models.client.Ticket.Collection.html">models.client.Ticket.Collection</a></li>
            
                <li><a href="../classes/models.client.TicketView.opinsysRobot.html">models.client.TicketView.opinsysRobot</a></li>
            
                <li><a href="../classes/models.client.Title.html">models.client.Title</a></li>
            
                <li><a href="../classes/models.client.UpdatesCollection.html">models.client.UpdatesCollection</a></li>
            
                <li><a href="../classes/models.server.Attachment.html">models.server.Attachment</a></li>
            
                <li><a href="../classes/models.server.Base.html">models.server.Base</a></li>
            
                <li><a href="../classes/models.server.Chunk.html">models.server.Chunk</a></li>
            
                <li><a href="../classes/models.server.Comment.html">models.server.Comment</a></li>
            
                <li><a href="../classes/models.server.Device.html">models.server.Device</a></li>
            
                <li><a href="../classes/models.server.Email.html">models.server.Email</a></li>
            
                <li><a href="../classes/models.server.Follower.html">models.server.Follower</a></li>
            
                <li><a href="../classes/models.server.Handler.html">models.server.Handler</a></li>
            
                <li><a href="../classes/models.server.Notification.html">models.server.Notification</a></li>
            
                <li><a href="../classes/models.server.Tag.html">models.server.Tag</a></li>
            
                <li><a href="../classes/models.server.Ticket.html">models.server.Ticket</a></li>
            
                <li><a href="../classes/models.server.Ticket.queries.html">models.server.Ticket.queries</a></li>
            
                <li><a href="../classes/models.server.Title.html">models.server.Title</a></li>
            
                <li><a href="../classes/models.server.User.html">models.server.User</a></li>
            
                <li><a href="../classes/models.TagMixin.html">models.TagMixin</a></li>
            
                <li><a href="../classes/models.TicketMixin.html">models.TicketMixin</a></li>
            
                <li><a href="../classes/models.UserInformation.html">models.UserInformation</a></li>
            
                <li><a href="../classes/React.ReactComponent.html">React.ReactComponent</a></li>
            
                <li><a href="../classes/ReactComponent.html">ReactComponent</a></li>
            
                <li><a href="../classes/ReactCompositeComponent.html">ReactCompositeComponent</a></li>
            
                <li><a href="../classes/ReactMountReady.html">ReactMountReady</a></li>
            
                <li><a href="../classes/ReactMultiChild.html">ReactMultiChild</a></li>
            
                <li><a href="../classes/ReactOwner.html">ReactOwner</a></li>
            
                <li><a href="../classes/ReactPropTransferer.html">ReactPropTransferer</a></li>
            
                <li><a href="../classes/ReactReconcileTransaction.html">ReactReconcileTransaction</a></li>
            
                <li><a href="../classes/ReactServerRenderingTransaction.html">ReactServerRenderingTransaction</a></li>
            
                <li><a href="../classes/ReactTestUtils.html">ReactTestUtils</a></li>
            
                <li><a href="../classes/ReactTextComponent.html">ReactTextComponent</a></li>
            
                <li><a href="../classes/server.Request.html">server.Request</a></li>
            
                <li><a href="../classes/server.Response.html">server.Response</a></li>
            
                <li><a href="../classes/test.helpers.html">test.helpers</a></li>
            
                <li><a href="../classes/utils.BrowserTitle.html">utils.BrowserTitle</a></li>
            
                <li><a href="../classes/utils.GridSQL.html">utils.GridSQL</a></li>
            
                <li><a href="../classes/utils.middleware.createResponseLogger.html">utils.middleware.createResponseLogger</a></li>
            
                <li><a href="../classes/utils.middleware.createSlowInternet.html">utils.middleware.createSlowInternet</a></li>
            
                <li><a href="../classes/utils.Puavo.html">utils.Puavo</a></li>
            
                <li><a href="../classes/utils.Superagent.html">utils.Superagent</a></li>
            
                <li><a href="../classes/utils.Transaction.html">utils.Transaction</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/filesize.html">filesize</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected" checked>
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private" checked>
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated" checked>
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: components/Main.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/** @jsx React.DOM */
&quot;use strict&quot;;

var React = require(&quot;react/addons&quot;);
var Backbone = require(&quot;backbone&quot;);
var _ = require(&quot;lodash&quot;);
var Link = require(&quot;react-router&quot;).Link;
var Modal = require(&quot;react-bootstrap/Modal&quot;);
var ButtonGroup = require(&quot;react-bootstrap/ButtonGroup&quot;);

var User = require(&quot;app/models/client/User&quot;);
var Ticket = require(&quot;app/models/client/Ticket&quot;);
var Comment = require(&quot;app/models/client/Comment&quot;);
var BackboneMixin = require(&quot;./BackboneMixin&quot;);
var ErrorMessage = require(&quot;./ErrorMessage&quot;);
var UserInformation = require(&quot;./UserInformation&quot;);
var NotificationsHub = require(&quot;./NotificationsHub&quot;);
var NotificationBox = require(&quot;./NotificationBox&quot;);
var BrowserTitle = require(&quot;app/utils/BrowserTitle&quot;);
var captureError = require(&quot;app/utils/captureError&quot;);


/**
 * Root React component. The app starts here
 *
 * @namespace components
 * @class Main
 * @extends react.ReactComponent
 * @constructor
 * @param {Object} props
 * @param {Socket.IO} props.io Socket.IO socket
 * @param {BrowserTitle} props.title BrowserTitle instance
 */
var Main = React.createClass({

    mixins: [BackboneMixin],

    propTypes: {
        title: React.PropTypes.instanceOf(BrowserTitle).isRequired,
        io: React.PropTypes.shape({
            on: React.PropTypes.func.isRequired,
            off: React.PropTypes.func.isRequired
        }).isRequired
    },

    getInitialState: function() {
        return {
            user: new User(window.USER),
            unreadTickets: Ticket.collection(),
            lastUpdate: null
        };
    },

    fetchUnreadTickets: function() {
        return this.state.unreadTickets.fetchWithUnreadComments()
            .catch(captureError(&quot;Ilmoitusten lataaminen epäonnistui&quot;));
    },

    handleFollowerUpdate: function(update) {
        this.fetchUnreadTickets();
        var comment = new Comment(update);
        this.setState({ lastUpdate: comment });
    },

    componentDidMount: function() {
        this.fetchUnreadTickets = _.throttle(this.fetchUnreadTickets, 2000);
        this.fetchUnreadTickets();
        Ticket.on(&quot;markedAsRead&quot;, this.fetchUnreadTickets);
        window.addEventListener(&quot;focus&quot;, this.fetchUnreadTickets);
        Backbone.on(&quot;error&quot;, this.handleUnhandledError);
        this.props.io.on(&quot;followerUpdate&quot;, this.handleFollowerUpdate);
    },

    componentWillUnmount: function() {
        window.removeEventListener(&quot;focus&quot;, this.fetchUnreadTickets);
        Backbone.off(&quot;error&quot;, this.handleUnhandledError);
        this.props.io.off(&quot;followerUpdate&quot;, this.handleFollowerUpdate);
    },

    handleUnhandledError: function(error, customMessage) {
        console.error(customMessage + &quot;:&quot;, error.message);
        if (error.stack) console.error(error.stack);
        this.renderInModal(&quot;Uups! Jotain odottamatonta tapahtui :(&quot;, function(){
            return &lt;ErrorMessage error={error} customMessage={customMessage} /&gt;;
        }, function() {
            window.scrollTo(0, 0);
        });
    },


    /**
     * @method renderInModal
     * @param {String} title
     * @param {Function} renderModalContent
     *      Function returning a React component
     * @param {Function} renderModalContent.close
     *      Call this function to close the modal window
     */
    renderInModal: function(title, render, cb) {
        var self = this;
        this.setState({ renderModalContent: function() {
            return (
                &lt;Modal
                    onRequestHide={function(){}}
                    title={title} &gt;
                    {render(self.closeModal)}
                &lt;/Modal&gt;
            );
        } }, cb);
    },

    closeModal: function(e) {
        this.setState({ renderModalContent: null });
    },

    /**
     * Remove the NotificationBox from the the view
     *
     * @method dismissNotificationBox
     */
    dismissNotificationBox: function() {
        this.setState({ lastUpdate: null });
    },

    renderNotificationBox: function() {
        var comment = this.state.lastUpdate;
        var ticket = comment.ticket();
        var creator = comment.createdBy();
        var commentString = comment.get(&quot;comment&quot;);
        if (commentString.length &gt; 100) {
            commentString = commentString.slice(0, 100) + &quot;...&quot;;
        }
        return (
            &lt;NotificationBox onDismiss={this.dismissNotificationBox} timeout={1000*10}&gt;
                &lt;Link to=&quot;ticket&quot;
                    onClick={this.dismissNotificationBox}
                    params={{id: comment.get(&quot;ticketId&quot;) }}
                    query={{scrollTo: &quot;firstUnread&quot; }}&gt;
                    &lt;b&gt;{creator.getFullName()}&lt;/b&gt; lisäsi kommentin &lt;b&gt;{commentString}&lt;/b&gt; tukipyyntöön &lt;b&gt;{ticket.getCurrentTitle()}&lt;/b&gt;
                &lt;/Link&gt;
            &lt;/NotificationBox&gt;
        );
    },

    render: function() {
        var user = this.state.user;
        var unreadTickets = this.state.unreadTickets;
        this.props.title.setNotificationCount(unreadTickets.size());
        this.props.title.activateOnNextTick();

        return (
            &lt;div className=&quot;Main&quot;&gt;

                {this.state.lastUpdate &amp;&amp; this.renderNotificationBox()}

                &lt;div className=&quot;wrapper container-fluid&quot;&gt;
                    &lt;h1 className=&quot;site-header&quot;&gt;&lt;a href=&quot;/&quot;&gt;Opinsys tukipalvelu&lt;/a&gt;&lt;/h1&gt;
                    {this.state.renderModalContent &amp;&amp; this.state.renderModalContent()}
                    &lt;div className=&quot;topmenu row&quot;&gt;

                        &lt;div className=&quot;user-info pull-right&quot;&gt;
                            &lt;UserInformation user={user} /&gt;
                        &lt;/div&gt;

                        &lt;ButtonGroup className=&quot;top-buttons&quot;&gt;
                            &lt;Link className=&quot;btn btn-default top-button&quot; to=&quot;new&quot;&gt;
                                &lt;i className=&quot;fa fa-pencil-square-o&quot;&gt;&lt;/i&gt;Uusi tukipyyntö
                            &lt;/Link&gt;

                            &lt;Link className=&quot;btn btn-default top-button&quot; to=&quot;tickets&quot;&gt;
                                &lt;i className=&quot;fa fa-home&quot;&gt;&lt;/i&gt;Omat tukipyynnöt
                            &lt;/Link&gt;
                            &lt;NotificationsHub user={user} tickets={unreadTickets} className=&quot;top-button&quot; /&gt;
                        &lt;/ButtonGroup&gt;
                    &lt;/div&gt;

                    &lt;div className=&quot;main-wrap clearfix&quot; &gt;
                        &lt;div className=&quot;main-content&quot;&gt;

                            &lt;this.props.activeRouteHandler
                                renderInModal={this.renderInModal}
                                unreadTickets={unreadTickets}
                                user={this.state.user} /&gt;

                        &lt;/div&gt;

                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        );
    }

});

module.exports = Main;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
